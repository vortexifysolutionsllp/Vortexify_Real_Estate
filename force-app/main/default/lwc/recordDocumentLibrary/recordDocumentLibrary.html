<template>
    <div class="slds-card document-library">

        <!-- ================= HEADER ================= -->
        <div class="slds-card__header slds-grid slds-grid_align-spread slds-p-horizontal_medium slds-p-vertical_small">

            <h2 class="slds-text-heading_medium slds-truncate">
                Document Library
            </h2>

            <div class="header-actions">
                <lightning-button label="Expand All" icon-name="utility:expand_all" variant="neutral"
                    onclick={expandAll}>
                </lightning-button>

                <lightning-button label="Collapse All" icon-name="utility:collapse_all" variant="neutral"
                    class="slds-m-left_x-small" onclick={collapseAll}>
                </lightning-button>

                <lightning-button label="Refresh" icon-name="utility:refresh" variant="neutral"
                    class="slds-m-left_small" onclick={refreshComp}>
                </lightning-button>

                <lightning-button variant="brand" label="Create Folder" class="slds-m-left_small"
                    onclick={showModalBoxFolder}>
                </lightning-button>
            </div>
        </div>

        <!-- ================= SPINNER ================= -->
        <template if:true={showSpinner}>
            <div class="slds-p-around_medium slds-align_absolute-center">
                <lightning-spinner size="medium"></lightning-spinner>
            </div>
        </template>

        <!-- ================= FOLDER LIST ================= -->
        <div class="slds-card__body slds-p-horizontal_medium slds-p-bottom_small">

            <template for:each={folderList} for:item="doc">
                <!-- -------- Folder Row -------- -->
                <div key={doc.Id} class="folder-row">

                    <div class="folder-left">
                        <lightning-button-icon icon-name={doc.toggleIcon} variant="bare" size="small"
                            alternative-text="Expand / Collapse" data-id={doc.Id} onclick={toggleSection}>
                        </lightning-button-icon>

                        <lightning-icon icon-name="utility:open_folder" size="small" class="slds-m-horizontal_x-small">
                        </lightning-icon>

                        <span
                            class="folder-name slds-truncate"
                            title={doc.Name}>
                            {doc.Name}
                        </span>
                    </div>

                    <lightning-button label="Upload" icon-name="utility:upload" variant="neutral" data-id={doc.Id}
                        onclick={showUploadModal}>
                    </lightning-button>
                </div>

                <!-- -------- File List -------- -->
                <template if:true={doc.isExpanded}>
                    <div key={doc.filesKey} class="file-container">

                        <!-- Files present -->
                        <template if:true={doc.ContentDocumentLinks.length}>
                            <template for:each={doc.ContentDocumentLinks} for:item="file">

                                <div key={file.ContentDocumentId} class="file-row">

                                    <div class="file-left">
                                        <lightning-icon icon-name="doctype:attachment" size="x-small"
                                            class="slds-m-right_x-small">
                                        </lightning-icon>

                                        <span
                                            class="file-name slds-truncate"
                                            title={file.ContentDocument.Title}>
                                            {file.ContentDocument.Title}
                                        </span>
                                    </div>

                                    <div class="file-actions">
                                        <lightning-button-icon icon-name="utility:preview" alternative-text="Preview"
                                            title="Preview" data-id={file.ContentDocumentId} onclick={handlePreview}>
                                        </lightning-button-icon>

                                        <lightning-button-icon icon-name="utility:delete" variant="destructive"
                                            alternative-text="Delete" title="Delete" data-id={file.ContentDocumentId}
                                            onclick={handleDelete}>
                                        </lightning-button-icon>
                                    </div>
                                </div>
                            </template>
                        </template>

                        <!-- Empty State -->
                        <template if:false={doc.ContentDocumentLinks.length}>
                            <div key={doc.emptyKey} class="empty-files">
                                No documents found
                            </div>
                        </template>

                    </div>
                </template>
            </template>
        </div>
    </div>

    <!-- ================= UPLOAD MODAL ================= -->
    <template if:true={isShowModal}>
        <section class="slds-modal slds-fade-in-open" role="dialog" aria-modal="true">

            <div class="slds-modal__container">
                <header class="slds-modal__header">
                    <h2 class="slds-text-heading_medium">
                        Upload File
                    </h2>
                </header>

                <div class="slds-modal__content slds-p-around_medium slds-relative">

                    <!-- Spinner overlay -->
                    <template if:true={isUploading}>
                        <div class="slds-spinner_container">
                            <lightning-spinner size="medium"></lightning-spinner>
                        </div>
                    </template>

                    <!-- File input -->
                    <lightning-input type="file" label="Select File" disabled={isUploading} onchange={handleFileChange}>
                    </lightning-input>

                    <!-- Inline error -->
                    <template if:true={uploadErrorMessage}>
                        <div class="slds-text-color_error slds-m-top_small">
                            {uploadErrorMessage}
                        </div>
                    </template>

                </div>

                <footer class="slds-modal__footer">
                    <lightning-button label="Cancel" disabled={isUploading} onclick={hideModalBox}>
                    </lightning-button>

                    <lightning-button variant="brand" label="Upload" disabled={isUploading} onclick={handleUpload}>
                    </lightning-button>
                </footer>
            </div>
        </section>

        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>


    <!-- ================= CREATE FOLDER MODAL ================= -->
    <template if:true={isShowModalFolder}>
        <section class="slds-modal slds-fade-in-open" role="dialog" aria-modal="true">

            <div class="slds-modal__container">
                <header class="slds-modal__header">
                    <h2 class="slds-text-heading_medium">
                        Create Folder
                    </h2>
                </header>

                <div class="slds-modal__content slds-p-around_medium">
                    <lightning-input label="Folder Name" required onchange={handleChangeFolder}>
                    </lightning-input>
                </div>

                <footer class="slds-modal__footer">
                    <lightning-button label="Cancel" onclick={hideModalBoxFolder}>
                    </lightning-button>

                    <lightning-button variant="brand" label="Create" onclick={handleFolderCreation}>
                    </lightning-button>
                </footer>
            </div>
        </section>

        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>
</template>